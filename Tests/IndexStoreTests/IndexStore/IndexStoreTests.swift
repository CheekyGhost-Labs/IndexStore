//
//  IndexStoreTests.swift
//  IndexStoreTests
//
//  Copyright (c) CheekyGhost Labs 2022. All Rights Reserved.
//

import Files
import XCTest

@testable import IndexStore

final class IndexStoreTests: XCTestCase {

    // MARK: - Properties

    var instanceUnderTest: IndexStore!

    var sampleSourceFilePaths: [String] {
        instanceUnderTest.swiftSourceFiles().filter {
            $0.contains("IndexStoreTests/Samples") && !$0.contains("InvocationTestCase")
        }
    }

    // MARK: - Lifecycle

    override func setUpWithError() throws {
        try super.setUpWithError()
        let configuration = try loadDefaultConfiguration()
        instanceUnderTest = IndexStore(configuration: configuration, logger: .test)
        instanceUnderTest.pollForChangesAndWait()
    }

    override func tearDownWithError() throws {
        try super.tearDownWithError()
        instanceUnderTest = nil
    }

    // MARK: - Helpers

    func loadDefaultConfiguration() throws -> Configuration {
        let configPath = "\(Bundle.module.resourcePath ?? "")/Configurations/test_configuration.json"
        let configUrl = URL(fileURLWithPath: configPath)
        let data = try Data(contentsOf: configUrl)
        let decoded = try JSONDecoder().decode(Configuration.self, from: data)
        return decoded
    }

    func pathSuffix(_ sourceName: String) -> String {
        "IndexStore/Tests/IndexStoreTests/Samples/\(sourceName)"
    }

    // MARK: - Tests: Direct

    // NOTE: Expensive task time wise
    func test_querySymbols_inSourceFiles_classes_willReturnExpectedValues() throws {
        let query = IndexStoreQuery.classDeclarations(in: sampleSourceFilePaths)
        let results = instanceUnderTest.querySymbols(query)
        XCTAssertEqual(results.count, 13)
        var result = results[0]
        XCTAssertNil(result.parent)
        XCTAssertEqual(result.name, "RootClass")
        XCTAssertEqual(result.sourceKind, .class)
        XCTAssertTrue(result.location.path.hasSuffix(pathSuffix("Classes.swift")))
        XCTAssertEqual(result.location.line, 3)
        XCTAssertEqual(result.location.column, 7)
        XCTAssertEqual(result.location.offset, 7)
        result = results[1]
        XCTAssertEqual(result.name, "NestedClass")
        XCTAssertEqual(result.sourceKind, .class)
        XCTAssertTrue(result.location.path.hasSuffix(pathSuffix("Classes.swift")))
        XCTAssertEqual(result.location.line, 5)
        XCTAssertEqual(result.location.column, 11)
        XCTAssertEqual(result.location.offset, 11)
        XCTAssertEqual(result.parent?.name, "RootClass")
        // add remainder
    }

    func test_querySymbols_inSourceFiles_rootClass_willReturnExpectedValues() throws {
        let sourceFiles = instanceUnderTest.swiftSourceFiles().filter { $0.contains("IndexStoreTests/Samples") }
        let query = IndexStoreQuery.classDeclarations(in: sourceFiles, matching: "RootClass")
        let results = instanceUnderTest.querySymbols(query)
        XCTAssertEqual(results.count, 1)
        let result = results[0]
        XCTAssertNil(result.parent)
        XCTAssertEqual(result.name, "RootClass")
        XCTAssertEqual(result.sourceKind, .class)
        XCTAssertTrue(result.location.path.hasSuffix(pathSuffix("Classes.swift")))
        XCTAssertEqual(result.location.line, 3)
        XCTAssertEqual(result.location.column, 7)
        XCTAssertEqual(result.location.offset, 7)
    }

    // MARK: - Declarations: Classes

    func test_querySymbols_classes_root_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.classDeclarations(matching: "RootClass"))
        let expectedPathSuffix = pathSuffix("Classes.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootClass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 3)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
    }

    func test_querySymbols_classes_nested_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.classDeclarations(matching: "NestedClass"))
        let expectedPathSuffix = pathSuffix("Classes.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertEqual(targetResult.parent?.name, "RootClass")
        XCTAssertEqual(targetResult.parent?.sourceKind, .class)
        XCTAssertEqual(targetResult.name, "NestedClass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 5)
        XCTAssertEqual(targetResult.location.column, 11)
        XCTAssertEqual(targetResult.location.offset, 11)
    }

    func test_querySymbols_classes_doubleNested_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.classDeclarations(matching: "DoubleNestedClass"))
        let expectedPathSuffix = pathSuffix("Classes.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertEqual(targetResult.parent?.name, "NestedClass")
        XCTAssertEqual(targetResult.parent?.sourceKind, .class)
        XCTAssertEqual(targetResult.parent?.parent?.name, "RootClass")
        XCTAssertEqual(targetResult.parent?.parent?.sourceKind, .class)
        XCTAssertEqual(targetResult.name, "DoubleNestedClass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 7)
        XCTAssertEqual(targetResult.location.column, 15)
        XCTAssertEqual(targetResult.location.offset, 15)
    }

    func test_querySymbols_classes_notClassType_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.classDeclarations(matching: "RootStruct"))
        XCTAssertEqual(results.count, 0)
    }

    // MARK: - Tests: Declarations: Structs

    func test_querySymbols_structs_root_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.structDeclarations(matching: "RootStruct"))
        let expectedPathSuffix = pathSuffix("Structs.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootStruct")
        XCTAssertEqual(targetResult.sourceKind, .struct)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 3)
        XCTAssertEqual(targetResult.location.column, 8)
        XCTAssertEqual(targetResult.location.offset, 8)
    }

    func test_querySymbols_structs_nested_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.structDeclarations(matching: "NestedStruct"))
        let expectedPathSuffix = pathSuffix("Structs.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertEqual(targetResult.parent?.name, "RootStruct")
        XCTAssertEqual(targetResult.parent?.sourceKind, .struct)
        XCTAssertEqual(targetResult.name, "NestedStruct")
        XCTAssertEqual(targetResult.sourceKind, .struct)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 5)
        XCTAssertEqual(targetResult.location.column, 12)
        XCTAssertEqual(targetResult.location.offset, 12)
    }

    func test_querySymbols_structs_doubleNested_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.structDeclarations(matching: "DoubleNestedStruct"))
        let expectedPathSuffix = pathSuffix("Structs.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertEqual(targetResult.parent?.name, "NestedStruct")
        XCTAssertEqual(targetResult.parent?.sourceKind, .struct)
        XCTAssertEqual(targetResult.parent?.parent?.name, "RootStruct")
        XCTAssertEqual(targetResult.parent?.parent?.sourceKind, .struct)
        XCTAssertEqual(targetResult.name, "DoubleNestedStruct")
        XCTAssertEqual(targetResult.sourceKind, .struct)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 7)
        XCTAssertEqual(targetResult.location.column, 16)
        XCTAssertEqual(targetResult.location.offset, 16)
    }

    func test_querySymbols_structs_Inheritence_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.structDeclarations(matching: "InheritenceStruct"))
        let expectedPathSuffix = pathSuffix("Inheritence.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertEqual(targetResult.name, "InheritenceStruct")
        XCTAssertEqual(targetResult.sourceKind, .struct)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 3)
        XCTAssertEqual(targetResult.location.column, 8)
        XCTAssertEqual(targetResult.location.offset, 8)
        XCTAssertEqual(targetResult.inheritance.count, 2)
        var nextInheritence = targetResult.inheritance[0]
        XCTAssertEqual(nextInheritence.name, "ProtocolWithSystemInheritence")
        XCTAssertEqual(nextInheritence.sourceKind, .protocol)
        XCTAssertEqual(nextInheritence.location.line, 5)
        XCTAssertEqual(nextInheritence.location.column, 10)
        XCTAssertEqual(nextInheritence.location.offset, 10)
        XCTAssertTrue(nextInheritence.location.path.hasSuffix("Protocols.swift"))
        nextInheritence = targetResult.inheritance[1]
        XCTAssertEqual(nextInheritence.name, "RootProtocol")
        XCTAssertEqual(nextInheritence.sourceKind, .protocol)
        XCTAssertEqual(nextInheritence.location.line, 3)
        XCTAssertEqual(nextInheritence.location.column, 10)
        XCTAssertEqual(nextInheritence.location.offset, 10)
        XCTAssertTrue(nextInheritence.location.path.hasSuffix("Protocols.swift"))
    }

    func test_querySymbols_structs_notStructType_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.structDeclarations(matching: "RootClass"))
        XCTAssertEqual(results.count, 0)
    }

    // MARK: - Tests: Declarations: Enums

    func test_querySymbols_enums_root_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.enumDeclarations(matching: "RootEnum"))
        let expectedPathSuffix = pathSuffix("Enums.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootEnum")
        XCTAssertEqual(targetResult.sourceKind, .enum)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 3)
        XCTAssertEqual(targetResult.location.column, 6)
        XCTAssertEqual(targetResult.location.offset, 6)
    }

    func test_querySymbols_enums_nested_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.enumDeclarations(matching: "NestedEnum"))
        let expectedPathSuffix = pathSuffix("Enums.swift")
        XCTAssertEqual(results.count, 3)
        let nestedEnum = results[0]
        XCTAssertEqual(nestedEnum.parent?.name, "RootEnum")
        XCTAssertEqual(nestedEnum.parent?.sourceKind, .enum)
        XCTAssertEqual(nestedEnum.name, "NestedEnum")
        XCTAssertEqual(nestedEnum.sourceKind, .enum)
        XCTAssertTrue(nestedEnum.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(nestedEnum.location.line, 5)
        XCTAssertEqual(nestedEnum.location.column, 10)
        XCTAssertEqual(nestedEnum.location.offset, 10)
        let structEnum = results[1]
        XCTAssertEqual(structEnum.parent?.name, "EnumStruct")
        XCTAssertEqual(structEnum.parent?.sourceKind, .struct)
        XCTAssertEqual(structEnum.name, "NestedEnum")
        XCTAssertEqual(structEnum.sourceKind, .enum)
        XCTAssertTrue(structEnum.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(structEnum.location.line, 15)
        XCTAssertEqual(structEnum.location.column, 10)
        XCTAssertEqual(structEnum.location.offset, 10)
        let classEnum = results[2]
        XCTAssertEqual(classEnum.parent?.name, "ClassEnum")
        XCTAssertEqual(classEnum.parent?.sourceKind, .class)
        XCTAssertEqual(classEnum.name, "NestedEnum")
        XCTAssertEqual(classEnum.sourceKind, .enum)
        XCTAssertTrue(classEnum.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(classEnum.location.line, 22)
        XCTAssertEqual(classEnum.location.column, 10)
        XCTAssertEqual(classEnum.location.offset, 10)
    }

    func test_querySymbols_enums_doubleNested_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.enumDeclarations(matching: "DoubleNestedEnum"))
        let expectedPathSuffix = pathSuffix("Enums.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertEqual(targetResult.parent?.name, "NestedEnum")
        XCTAssertEqual(targetResult.parent?.sourceKind, .enum)
        XCTAssertEqual(targetResult.parent?.parent?.name, "RootEnum")
        XCTAssertEqual(targetResult.parent?.parent?.sourceKind, .enum)
        XCTAssertEqual(targetResult.name, "DoubleNestedEnum")
        XCTAssertEqual(targetResult.sourceKind, .enum)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 7)
        XCTAssertEqual(targetResult.location.column, 14)
        XCTAssertEqual(targetResult.location.offset, 14)
    }

    func test_querySymbols_enums_notEnumType_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.enumDeclarations(matching: "RootClass"))
        XCTAssertEqual(results.count, 0)
    }

    // MARK: - Tests: Declarations: Protocols

    func test_querySymbols_protocols_basic_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.protocolDeclarations(matching: "RootProtocol"))
        let expectedPathSuffix = pathSuffix("Protocols.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootProtocol")
        XCTAssertEqual(targetResult.sourceKind, .protocol)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 3)
        XCTAssertEqual(targetResult.location.column, 10)
        XCTAssertEqual(targetResult.location.offset, 10)
    }

    func test_querySymbols_protocols_system_inheritence_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.protocolDeclarations(matching: "ProtocolWithSystemInheritence"))
        let expectedPathSuffix = pathSuffix("Protocols.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "ProtocolWithSystemInheritence")
        XCTAssertEqual(targetResult.sourceKind, .protocol)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 5)
        XCTAssertEqual(targetResult.location.column, 10)
        XCTAssertEqual(targetResult.location.offset, 10)
    }

    func test_querySymbols_protocols_custom_inheritence_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.protocolDeclarations(matching: "ProtocolWithInheritence"))
        let expectedPathSuffix = pathSuffix("Protocols.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "ProtocolWithInheritence")
        XCTAssertEqual(targetResult.sourceKind, .protocol)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 9)
        XCTAssertEqual(targetResult.location.column, 10)
        XCTAssertEqual(targetResult.location.offset, 10)
    }

    func test_querySymbols_protocols_notProtocolType_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.protocolDeclarations(matching: "ProtocolName"))
        XCTAssertEqual(results.count, 0)
    }

    // MARK: - Tests: Extension

    func test_querySymbols_extension_class_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.extensions(ofType: "RootClass"))
        let expectedPathSuffix = pathSuffix("Extensions.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootClass")
        XCTAssertEqual(targetResult.sourceKind, .extension)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 8)
        XCTAssertEqual(targetResult.location.column, 11)
        XCTAssertEqual(targetResult.location.offset, 11)
    }

    func test_querySymbols_extension_struct_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.extensions(ofType: "RootStruct"))
        let expectedPathSuffix = pathSuffix("Extensions.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootStruct")
        XCTAssertEqual(targetResult.sourceKind, .extension)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 17)
        XCTAssertEqual(targetResult.location.column, 11)
        XCTAssertEqual(targetResult.location.offset, 11)
    }

    func test_querySymbols_extension_enum_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.extensions(ofType: "RootEnum"))
        let expectedPathSuffix = pathSuffix("Extensions.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootEnum")
        XCTAssertEqual(targetResult.sourceKind, .extension)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 25)
        XCTAssertEqual(targetResult.location.column, 11)
        XCTAssertEqual(targetResult.location.offset, 11)
    }

    func test_querySymbols_extension_protocol_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.extensions(ofType: "RootProtocol"))
        let expectedPathSuffix = pathSuffix("Extensions.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootProtocol")
        XCTAssertEqual(targetResult.sourceKind, .extension)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 34)
        XCTAssertEqual(targetResult.location.column, 11)
        XCTAssertEqual(targetResult.location.offset, 11)
    }

    func test_querySymbols_extension_multiple_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.extensions(ofType: "ProtocolWithSystemInheritence"))
        let expectedPathSuffix = pathSuffix("Extensions.swift")
        XCTAssertEqual(results.count, 2)
        let firstResult = results[0]
        XCTAssertNil(firstResult.parent)
        XCTAssertEqual(firstResult.name, "ProtocolWithSystemInheritence")
        XCTAssertEqual(firstResult.sourceKind, .extension)
        XCTAssertTrue(firstResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(firstResult.location.line, 42)
        XCTAssertEqual(firstResult.location.column, 11)
        XCTAssertEqual(firstResult.location.offset, 11)
        let lastResult = results[1]
        XCTAssertNil(lastResult.parent)
        XCTAssertEqual(lastResult.name, "ProtocolWithSystemInheritence")
        XCTAssertEqual(lastResult.sourceKind, .extension)
        XCTAssertTrue(lastResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(lastResult.location.line, 46)
        XCTAssertEqual(lastResult.location.column, 11)
        XCTAssertEqual(lastResult.location.offset, 11)
    }

    func test_sourceSymbolsExtendingType_willReturnExpectedValues() {
        let results = instanceUnderTest.querySymbols(.extensions(ofType: "ProtocolWithSystemInheritence"))
        let expectedPathSuffix = pathSuffix("Extensions.swift")
        XCTAssertEqual(results.count, 2)
        let firstResult = results[0]
        XCTAssertNil(firstResult.parent)
        XCTAssertEqual(firstResult.name, "ProtocolWithSystemInheritence")
        XCTAssertEqual(firstResult.sourceKind, .extension)
        XCTAssertTrue(firstResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(firstResult.location.line, 42)
        XCTAssertEqual(firstResult.location.column, 11)
        XCTAssertEqual(firstResult.location.offset, 11)
        let lastResult = results[1]
        XCTAssertNil(lastResult.parent)
        XCTAssertEqual(lastResult.name, "ProtocolWithSystemInheritence")
        XCTAssertEqual(lastResult.sourceKind, .extension)
        XCTAssertTrue(lastResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(lastResult.location.line, 46)
        XCTAssertEqual(lastResult.location.column, 11)
        XCTAssertEqual(lastResult.location.offset, 11)
    }

    // MARK: - Tests: TypeAlias

    func test_querySymbols_typeAlias_root_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "RootAlias"))
        let expectedPathSuffix = pathSuffix("Typealias.swift")
        XCTAssertEqual(results.count, 1)
        let targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "RootAlias")
        XCTAssertEqual(targetResult.sourceKind, .typealias)
        XCTAssertTrue(targetResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(targetResult.location.line, 3)
        XCTAssertEqual(targetResult.location.column, 11)
        XCTAssertEqual(targetResult.location.offset, 11)
    }

    func test_querySymbols_typeAlias_nested_enum_many_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "NestedAlias"))
        let expectedPathSuffix = pathSuffix("Typealias.swift")
        XCTAssertEqual(results.count, 2)
        let fooResult = results[0]
        XCTAssertEqual(fooResult.parent?.name, "Foo")
        XCTAssertEqual(fooResult.parent?.sourceKind, .enum)
        XCTAssertEqual(fooResult.name, "NestedAlias")
        XCTAssertEqual(fooResult.sourceKind, .typealias)
        XCTAssertTrue(fooResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(fooResult.location.line, 7)
        XCTAssertEqual(fooResult.location.column, 15)
        XCTAssertEqual(fooResult.location.offset, 15)
        let barResult = results[1]
        XCTAssertEqual(barResult.parent?.name, "Bar")
        XCTAssertEqual(barResult.parent?.sourceKind, .enum)
        XCTAssertEqual(barResult.name, "NestedAlias")
        XCTAssertEqual(barResult.sourceKind, .typealias)
        XCTAssertTrue(barResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(barResult.location.line, 17)
        XCTAssertEqual(barResult.location.column, 15)
        XCTAssertEqual(barResult.location.offset, 15)
    }

    func test_querySymbols_typeAlias_nested_struct_single_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "StructAlias"))
        let expectedPathSuffix = pathSuffix("Typealias.swift")
        XCTAssertEqual(results.count, 1)
        let fooResult = results[0]
        XCTAssertEqual(fooResult.parent?.name, "FooBar")
        XCTAssertEqual(fooResult.parent?.sourceKind, .struct)
        XCTAssertEqual(fooResult.name, "StructAlias")
        XCTAssertEqual(fooResult.sourceKind, .typealias)
        XCTAssertTrue(fooResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(fooResult.location.line, 23)
        XCTAssertEqual(fooResult.location.column, 15)
        XCTAssertEqual(fooResult.location.offset, 15)
    }

    func test_querySymbols_typeAlias_nested_class_single_willReturnExpectedValues() throws {
        let results = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "ClassAlias"))
        let expectedPathSuffix = pathSuffix("Typealias.swift")
        XCTAssertEqual(results.count, 1)
        let fooResult = results[0]
        XCTAssertEqual(fooResult.parent?.name, "FooBarClass")
        XCTAssertEqual(fooResult.parent?.sourceKind, .class)
        XCTAssertEqual(fooResult.name, "ClassAlias")
        XCTAssertEqual(fooResult.sourceKind, .typealias)
        XCTAssertTrue(fooResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(fooResult.location.line, 28)
        XCTAssertEqual(fooResult.location.column, 15)
        XCTAssertEqual(fooResult.location.offset, 15)
    }

    func test_querySymbols_typeAlias_structName_willReturnNoResults() throws {
        let results = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "FooBar"))
        XCTAssertEqual(results.count, 0)
    }

    // MARK: - Tests: Properties

    // TODO: Property query tests

    // MARK: - Tests: Functions

    func test_functions_matchingQuery_willReturnExpectedResults() throws {
        let results = instanceUnderTest.querySymbols(.functions("executeOrder"))
        XCTAssertEqual(results.count, 1)
        let function = try XCTUnwrap(results.first)
        // Function
        XCTAssertEqual(function.name, "executeOrder()")
        XCTAssertEqual(function.sourceKind, .instanceMethod)
        XCTAssertEqual(function.location.line, 22)
        XCTAssertEqual(function.location.column, 10)
        XCTAssertEqual(function.location.offset, 10)
        XCTAssertTrue(function.location.path.hasSuffix("Functions.swift"))
        // Parent
        let functionParent = try XCTUnwrap(function.parent)
        XCTAssertEqual(functionParent.name, "FunctionRootProtocol")
        XCTAssertEqual(functionParent.sourceKind, .protocol)
        XCTAssertEqual(functionParent.location.line, 20)
        XCTAssertEqual(functionParent.location.column, 10)
        XCTAssertEqual(functionParent.location.offset, 10)
        XCTAssertTrue(functionParent.location.path.hasSuffix("Functions.swift"))
    }

    func test_functions_inSourceFiles_withQuery_willReturnExpectedResults() throws {
        let results = instanceUnderTest.querySymbols(.functions(in: sampleSourceFilePaths, matching: "TestCaseInvocation"))
        print(results.count)
        // todo: finish
        XCTAssertEqual(results.count, 2)
        var function = results[0]
        // Function
        XCTAssertEqual(function.name, "standardTestCaseInvocation()")
        XCTAssertEqual(function.sourceKind, .instanceMethod)
        XCTAssertEqual(function.location.line, 7)
        XCTAssertEqual(function.location.column, 10)
        XCTAssertEqual(function.location.offset, 10)
        XCTAssertTrue(function.location.path.hasSuffix("Functions.swift"))
        // Parent
        var functionParent = try XCTUnwrap(function.parent)
        XCTAssertEqual(functionParent.name, "FunctionClass")
        XCTAssertEqual(functionParent.sourceKind, .class)
        XCTAssertEqual(functionParent.location.line, 3)
        XCTAssertEqual(functionParent.location.column, 7)
        XCTAssertEqual(functionParent.location.offset, 7)
        XCTAssertTrue(functionParent.location.path.hasSuffix("Functions.swift"))
        // Second Function
        function = results[1]
        XCTAssertEqual(function.name, "subclassTestCaseInvocation()")
        XCTAssertEqual(function.sourceKind, .instanceMethod)
        XCTAssertEqual(function.location.line, 11)
        XCTAssertEqual(function.location.column, 14)
        XCTAssertEqual(function.location.offset, 14)
        XCTAssertTrue(function.location.path.hasSuffix("Functions.swift"))
        // Second Function Parent
        functionParent = try XCTUnwrap(function.parent)
        XCTAssertEqual(functionParent.name, "NestedFunctionClass")
        XCTAssertEqual(functionParent.sourceKind, .class)
        XCTAssertEqual(functionParent.location.line, 9)
        XCTAssertEqual(functionParent.location.column, 11)
        XCTAssertEqual(functionParent.location.offset, 11)
        XCTAssertTrue(functionParent.location.path.hasSuffix("Functions.swift"))
    }

    func test_functions_inSourceFiles_noQuery_willReturnExpectedResults() throws {
        let dir = instanceUnderTest.configuration.projectDirectory
        // Not going into inheritence checks etc as the other tests cover it. This is also not ideal, however, can
        // revisit once time allows to avoid the description match.
        let expected: [String] = [
            "test() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Extensions.swift::5::10",
            "test() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Extensions.swift::10::10",
            "test() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Extensions.swift::18::10",
            "test() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Extensions.swift::27::10",
            "test() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Extensions.swift::35::10",
            "test() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Extensions.swift::43::10",
            "testTwo() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Extensions.swift::47::10",
            "performFunction(withPerson:) - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::5::10",
            "standardTestCaseInvocation() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::7::10",
            "subclassTestCaseInvocation() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::11::14",
            "notInvokedInTestCase() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::15::18",
            "performOperation(withName:) - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::21::10",
            "executeOrder() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::22::10",
            "performOperation(withAge:) - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::27::10",
            "performOperation(withName:age:) - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::32::10",
            "performOperation(withName:age:handler:) - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::36::10",
            "getter:instance - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::41::9",
            "setter:instance - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::41::9",
            "isolatedFunction() - function | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Functions.swift::48::6",
            "getter:name - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::5::9",
            "setter:name - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::5::9",
            "getter:name - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::10::9",
            "setter:name - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::10::9",
            "==(_:_:) - staticMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::12::24",
            "getter:name - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::19::9",
            "setter:name - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::19::9",
            "getter:name - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::24::9",
            "setter:name - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::24::9",
            "==(_:_:) - staticMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::26::24",
            "sample() - instanceMethod | IndexStoreTests::\(dir)/Tests/IndexStoreTests/Samples/Inheritence.swift::33::10"
        ]
        let results = instanceUnderTest.querySymbols(.functions(in: sampleSourceFilePaths))
        let descriptions = results.map(\.description)
        XCTAssertEqual(descriptions, expected)
    }

    // MARK: - Tests: Source Getting

    func test_querySymbols_typealias_willReturnExpectedDeclaration() throws {
        let details = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "SourceAlias"))
        let sourceLines = try details.map { try instanceUnderTest.declarationSource(forDetails: $0) }
        let expectedLines = [
            "    typealias SourceAlias = String",
            "    enum Bar { typealias SourceAlias = Int }",
        ]
        XCTAssertEqual(sourceLines, expectedLines)
    }

    func test_querySymbols_typealias_unresolvableLine_willThrowError() throws {
        let validDetails = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "SourceAlias"))[0]
        let location = SourceLocation(
            path: validDetails.location.path,
            moduleName: "IndexStoreTests",
            line: 100,
            column: 0,
            offset: 0,
            isSystem: false,
            isStale: false
        )
        let details = SourceSymbol(
            name: validDetails.name,
            usr: validDetails.usr,
            sourceKind: validDetails.sourceKind,
            roles: .declaration,
            location: location
        )
        let expectedError = SourceResolvingError.unableToResolveSourceLine(
            name: "SourceAlias",
            path: validDetails.location.path,
            line: 100
        )
        XCTAssertThrowsError(try instanceUnderTest.declarationSource(forDetails: details)) { error in
            XCTAssertEqual(error as? SourceResolvingError, expectedError)
        }
    }

    func test_querySymbols_typealias_contents_willReturnExpectedDeclaration() throws {
        let expectedContents =
            #"""
            import Foundation

            enum SourceContents {
                typealias SourceAlias = String
                enum Bar { typealias SourceAlias = Int }
            }

            """#
        let details = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "SourceAlias"))[0]
        let sourceContents = try instanceUnderTest.sourceContents(forDetails: details)
        XCTAssertEqual(sourceContents, expectedContents)
    }

    func test_querySymbols_typealias_missingFile_willThrowError() throws {
        let location = SourceLocation(
            path: "file://missing/file.swift",
            moduleName: "",
            line: 100,
            column: 0,
            offset: 0,
            isSystem: false,
            isStale: false
        )
        let details = SourceSymbol(
            name: "SourceAlias",
            usr: "",
            sourceKind: .typealias,
            roles: .declaration,
            location: location
        )
        let expectedError = SourceResolvingError.sourcePathDoesNotExist(path: location.path)
        XCTAssertThrowsError(try instanceUnderTest.sourceContents(forDetails: details)) { error in
            XCTAssertEqual(error as? SourceResolvingError, expectedError)
        }
    }

    func test_querySymbols_typealias_emptyFile_willThrowError() throws {
        let validDetails = instanceUnderTest.querySymbols(.typealiasDeclarations(matching: "SourceAlias"))[0]
        let emptyPath = validDetails.location.path.replacingOccurrences(of: "SourceContents.swift", with: "EmptySource.swift")
        let location = SourceLocation(
            path: emptyPath,
            moduleName: "IndexStoreTests",
            line: 0,
            column: 0,
            offset: 0,
            isSystem: false,
            isStale: false
        )
        let details = SourceSymbol(
            name: "SourceAlias",
            usr: "",
            sourceKind: .typealias,
            roles: .declaration,
            location: location
        )
        let expectedError = SourceResolvingError.sourceContentsIsEmpty(path: emptyPath)
        XCTAssertThrowsError(try instanceUnderTest.sourceContents(forDetails: details)) { error in
            XCTAssertEqual(error as? SourceResolvingError, expectedError)
        }
    }

    // MARK: Tests: Convenience: Protocol Conformance

    func test_typesConformingToProtocol_withSystemInheritence() throws {
        let results = instanceUnderTest.sourceSymbols(conformingToProtocol: "ProtocolWithSystemInheritence")
        XCTAssertEqual(results.count, 2)
        var targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "InheritenceStruct")
        XCTAssertEqual(targetResult.sourceKind, .struct)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 3)
        XCTAssertEqual(targetResult.location.column, 8)
        XCTAssertEqual(targetResult.location.offset, 8)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["ProtocolWithSystemInheritence", "RootProtocol"])
        targetResult = results[1]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "InheritenceClass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 8)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["RootProtocol", "ProtocolWithSystemInheritence"])
    }

    func test_typesConformingToProtocol_inSourceFiles_withSystemInheritence() throws {
        let sourceFiles = instanceUnderTest.swiftSourceFiles().filter { $0.contains("IndexStoreTests/Samples") }
        let results = instanceUnderTest.sourceSymbols(conformingToProtocol: "ProtocolWithSystemInheritence", in: sourceFiles)
        XCTAssertEqual(results.count, 2)
        var targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "InheritenceStruct")
        XCTAssertEqual(targetResult.sourceKind, .struct)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 3)
        XCTAssertEqual(targetResult.location.column, 8)
        XCTAssertEqual(targetResult.location.offset, 8)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["ProtocolWithSystemInheritence", "RootProtocol"])
        targetResult = results[1]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "InheritenceClass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 8)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["RootProtocol", "ProtocolWithSystemInheritence"])
    }

    func test_typesConformingToProtocol_withCustomInheritence() throws {
        let results = instanceUnderTest.sourceSymbols(conformingToProtocol: "ProtocolWithInheritence")
        XCTAssertEqual(results.count, 2)
        var targetResult = results[0]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "CustomInheritenceStruct")
        XCTAssertEqual(targetResult.sourceKind, .struct)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 17)
        XCTAssertEqual(targetResult.location.column, 8)
        XCTAssertEqual(targetResult.location.offset, 8)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["ProtocolWithInheritence", "RootProtocol"])
        targetResult = results[1]
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "CustomInheritenceClass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 22)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["RootProtocol", "ProtocolWithInheritence"])
        let inheritedInheritence = try XCTUnwrap(results[1].inheritance.last?.inheritance.first)
        XCTAssertNil(inheritedInheritence.parent)
        XCTAssertEqual(inheritedInheritence.name, "BaseProtocol")
        XCTAssertEqual(inheritedInheritence.sourceKind, .protocol)
        XCTAssertTrue(inheritedInheritence.location.path.hasSuffix("Protocols.swift"))
        XCTAssertEqual(inheritedInheritence.location.line, 7)
        XCTAssertEqual(inheritedInheritence.location.column, 10)
        XCTAssertEqual(inheritedInheritence.location.offset, 10)
        XCTAssertTrue(inheritedInheritence.inheritance.isEmpty)
    }

    // MARK: Tests: Convenience: Empty Extensions

    func test_sourceSymbolsForEmptyExtensionsOfType_willReturnExpectedValues() {
        let results = instanceUnderTest.sourceSymbols(forEmptyExtensionsMatching: .classDeclarations(matching: "RootClass"))
        let expectedPathSuffix = pathSuffix("Extensions.swift")
        XCTAssertEqual(results.count, 1)
        let firstResult = results[0]
        XCTAssertNil(firstResult.parent)
        XCTAssertEqual(firstResult.name, "RootClass")
        XCTAssertEqual(firstResult.sourceKind, .extension)
        XCTAssertTrue(firstResult.location.path.hasSuffix(expectedPathSuffix))
        XCTAssertEqual(firstResult.location.line, 13)
        XCTAssertEqual(firstResult.location.column, 11)
        XCTAssertEqual(firstResult.location.offset, 11)
    }

    // MARK: Tests: Convenience: Function Invocations in Test Case

    func test_functions_inSourceFiles_invokedInTestCase_willReturnExpectedResults() throws {
        let results = instanceUnderTest.querySymbols(.functions(in: sampleSourceFilePaths))
        let invokedNames = ["standardTestCaseInvocation()", "subclassTestCaseInvocation()"]
        // Invoked
        results.filter { invokedNames.contains($0.name) }.forEach {
            XCTAssertTrue(instanceUnderTest.isSymbolInvokedByTestCase($0))
        }
        // Not Invoked
        results.filter { !invokedNames.contains($0.name) }.forEach {
            XCTAssertFalse(instanceUnderTest.isSymbolInvokedByTestCase($0))
        }
    }

    func test_function_invokedInTestCase() throws {
        let results = instanceUnderTest.querySymbols(.functions("standardTestCaseInvocation"))
        let function = try XCTUnwrap(results.first)
        XCTAssertTrue(instanceUnderTest.isSymbolInvokedByTestCase(function))
    }

    func test_function_invokedInTestCaseSubclass() throws {
        let results = instanceUnderTest.querySymbols(.functions("subclassTestCaseInvocation"))
        let function = try XCTUnwrap(results.first)
        XCTAssertTrue(instanceUnderTest.isSymbolInvokedByTestCase(function))
    }

    func test_function_notInvokedInTestCaseSubclass() throws {
        let results = instanceUnderTest.querySymbols(.functions("notInvokedInTestCase"))
        let function = try XCTUnwrap(results.first)
        XCTAssertFalse(instanceUnderTest.isSymbolInvokedByTestCase(function))
    }

    // MARK: Tests: Convenience: Subclasses of

    func test_sourceSymbolsSubclassing_query_willReturnExpectedResults() throws {
        let results = instanceUnderTest.sourceSymbols(subclassing: "InheritenceClass")
        XCTAssertEqual(results.count, 1)
        let targetResult = try XCTUnwrap(results.first)
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "InheritenceSubclass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 31)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["InheritenceClass"])
    }

    func test_sourceSymbolsSubclassing_inSourceFiles_willReturnExpectedResults() throws {
        let results = instanceUnderTest.sourceSymbols(subclassing: "InheritenceClass", in: sampleSourceFilePaths)
        XCTAssertEqual(results.count, 1)
        let targetResult = try XCTUnwrap(results.first)
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "InheritenceSubclass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 31)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["InheritenceClass"])
    }

    func test_sourceSymbolsSubclassing_systemInheritence_willReturnExpectedResults() throws {
        let results = instanceUnderTest.sourceSymbols(subclassing: "NSObject")
        XCTAssertEqual(results.count, 1)
        let targetResult = try XCTUnwrap(results.first)
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "SystemInheritenceSubclass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 38)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["NSObject"])
    }

    func test_sourceSymbolsSubclassing_inSourceFiles_systemInheritence_willReturnExpectedResults() throws {
        let results = instanceUnderTest.sourceSymbols(subclassing: "NSObject", in: sampleSourceFilePaths)
        XCTAssertEqual(results.count, 1)
        let targetResult = try XCTUnwrap(results.first)
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "SystemInheritenceSubclass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 38)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["NSObject"])
    }

    func test_sourceSymbolsSubclassing_withCustomInheritence() throws {
        let results = instanceUnderTest.sourceSymbols(subclassing: "ProtocolWithInheritence")
        XCTAssertEqual(results.count, 2)
        var targetResult = try XCTUnwrap(results.first)
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "CustomInheritenceStruct")
        XCTAssertEqual(targetResult.sourceKind, .struct)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 17)
        XCTAssertEqual(targetResult.location.column, 8)
        XCTAssertEqual(targetResult.location.offset, 8)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["ProtocolWithInheritence", "RootProtocol"])
        targetResult = try XCTUnwrap(results.last)
        XCTAssertNil(targetResult.parent)
        XCTAssertEqual(targetResult.name, "CustomInheritenceClass")
        XCTAssertEqual(targetResult.sourceKind, .class)
        XCTAssertTrue(targetResult.location.path.hasSuffix("Inheritence.swift"))
        XCTAssertEqual(targetResult.location.line, 22)
        XCTAssertEqual(targetResult.location.column, 7)
        XCTAssertEqual(targetResult.location.offset, 7)
        XCTAssertEqual(targetResult.inheritance.map(\.name), ["RootProtocol", "ProtocolWithInheritence"])
        let inheritedInheritence = try XCTUnwrap(results[1].inheritance.last?.inheritance.first)
        XCTAssertNil(inheritedInheritence.parent)
        XCTAssertEqual(inheritedInheritence.name, "BaseProtocol")
        XCTAssertEqual(inheritedInheritence.sourceKind, .protocol)
        XCTAssertTrue(inheritedInheritence.location.path.hasSuffix("Protocols.swift"))
        XCTAssertEqual(inheritedInheritence.location.line, 7)
        XCTAssertEqual(inheritedInheritence.location.column, 10)
        XCTAssertEqual(inheritedInheritence.location.offset, 10)
        XCTAssertTrue(inheritedInheritence.inheritance.isEmpty)
    }

    // MARK: Tests: Convenience: Symbol Invocations

    func test_invocationsOfSymbol_willReturnExpectedResults() throws {
        // todo: finish
    }
}
